<div class="md-card">
  <div class="md-header">
    <span class="dot cyan"></span>
    <strong>Comentarii AI</strong>
  </div>

  <script type="application/json" id="ai-raw-json">{{ ai | tojson }}</script>
  <div class="md-content" id="ai-md-content"><div class="spinner-inline"></div></div>
</div>

<script>
(function(){
  function ensureScript(src, id){
    return new Promise((resolve) => {
      if (id && document.getElementById(id)) return resolve();
      const s = document.createElement('script'); if (id) s.id = id; s.src = src; s.onload = resolve; document.head.appendChild(s);
    });
  }
  function ensureCSS(href, id){
    if (id && document.getElementById(id)) return;
    const l = document.createElement('link'); if (id) l.id = id; l.rel = 'stylesheet'; l.href = href; document.head.appendChild(l);
  }

  const rawEl = document.getElementById('ai-raw-json');
  const target = document.getElementById('ai-md-content');
  if(!rawEl || !target) return;

  const raw = JSON.parse(rawEl.textContent || '""') || "";

  ensureCSS("https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css","prism-theme");
  Promise.all([
    ensureScript("https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js","marked-lib"),
    ensureScript("https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js","prism-core"),
    ensureScript("https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js","prism-sql"),
  ]).then(()=>{
    if (window.marked) {
      marked.setOptions({ gfm:true, breaks:true });
      const html = marked.parse(raw);
      target.innerHTML = html;
      if (window.Prism) Prism.highlightAll();
    } else {
      target.textContent = raw;
    }
  });
})();
</script>
